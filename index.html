<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AKPsi Alumni Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height:100%; margin:0; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script>
/* ===== Settings ===== */
const MAPBOX_TOKEN = 'pk.eyJ1Ijoia3RyYW4yNCIsImEiOiJjbWhkaDBodW8wMzBnMnRwcnRrZjk1dHExIn0.Mx71kV2hMNjCtuuRLB37gw';
const STYLE_URL    = 'mapbox://styles/ktran24/cmhdt73un001f01qvfzyndnek';
const GEOJSON_URL  = 'alumni.geojson?v=' + Date.now(); // cache-busting

/* Show year under name? (true) or inline next to name? (false) */
const YEAR_BELOW_NAME = true;

mapboxgl.accessToken = MAPBOX_TOKEN;
const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [0, 20],
  zoom: 1.4,
  projection: 'globe'
});
map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

map.on('style.load', () => {
  map.setFog({
    color: 'rgba(160,200,255,1)',
    'high-color': 'rgba(36,92,223,0.4)',
    'space-color': '#0b1434',
    'horizon-blend': 0.2,
    'star-intensity': 0.35
  });
});

/* ---------- Popup + Layout CSS ---------- */
const styleEl = document.createElement('style');
styleEl.textContent = `
  .mapboxgl-popup-content {
    padding: 14px 16px 16px 16px;
    border-radius: 12px;
    max-width: 500px;
  }
  .mapboxgl-popup-close-button {
    font-size: 24px !important;
    line-height: 24px !important;
    top: 6px !important;
    right: 8px !important;
    color: #041E42 !important;
    font-weight: 600;
  }
  .alum-wrap { width: 460px; max-width: 90vw; }
  .alum-header {
    font: 700 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica;
    color: #041E42; margin: 0 2px 8px;
  }
  .alum-list { max-height: 380px; overflow: auto; display: grid; gap: 25px; }
  .alum-card { display: grid; grid-template-columns: 90px 1fr; gap: 27px; align-items: center; }
  .alum-logo {
    width: 90px; height: 90px; background: #fff; border-radius: 12px;
    box-shadow: inset 0 0 0 1px #e6e9ef; object-fit: contain; object-position: center;
    padding: 8px; display: block;
  }
  .alum-logo.placeholder { display: flex; align-items: center; justify-content: center; color: #98a1b3; font-size: 10px; }
  .alum-name { font-weight: 800; color: #1B2344; font-size: 20px; line-height: 1.2; }
  .alum-company { color: #1B2344; font-size: 17px; margin-top: 3px; }
  .alum-meta { color: #A1A1A1; font-size: 15px; margin-top: 4px; }
  .alum-yearline { color: #A1A1A1; font-size: 15px; margin-top: 2px; }
`;
document.head.appendChild(styleEl);

/* ---------- Helpers for Graduation Year ---------- */
function extractFullYear(raw) {
  if (raw == null) return '';
  const m = String(raw).match(/(19|20)\d{2}/);
  return m ? m[0] : String(raw).trim();
}

function getGradYear(props = {}) {
  const direct =
    props['Graduation Year'] ??
    props.GradYear ??
    props['Grad Year'] ??
    props.GraduationYear ??
    props.GraduatingYear ??
    props['Class Year'] ??
    props.ClassYear ??
    props.Year ??
    props['Class of'];
  if (direct) return extractFullYear(direct);

  for (const [k, v] of Object.entries(props)) {
    const norm = k.replace(/\s|[\u00A0_]/g, '').toLowerCase();
    if (
      norm.includes('graduationyear') ||
      norm.includes('gradyear') ||
      norm.includes('classyear') ||
      norm.includes('classof') ||
      norm === 'year'
    ) {
      return extractFullYear(v);
    }
  }
  return '';
}

/* ---------- Popup builder ---------- */
function alumniPopupHTML(features) {
  const p0 = features[0]?.properties || {};
  const header = [p0.City || '', p0.Country || ''].filter(Boolean).join(', ');

  const cards = features.map(f => {
    const p = f.properties || {};
    const img = p.PhotoURL || p.Photo || p.Logo || '';
    const yrRaw = getGradYear(p);
    const yrFmt = yrRaw ? `Class of ${yrRaw}` : ''; // Always full year text

    const nameLine = `
      <div class="alum-name">${p.Name || ''}</div>
    `;
    const yearLine = (YEAR_BELOW_NAME && yrFmt)
      ? `<div class="alum-yearline">${yrFmt}</div>`
      : (!YEAR_BELOW_NAME && yrFmt ? `<span class="alum-yearline">${yrFmt}</span>` : '');

    return `
      <div class="alum-card">
        ${img
          ? `<img class="alum-logo" src="${img}" alt="" loading="lazy" />`
          : `<div class="alum-logo placeholder">No image</div>`}
        <div>
          ${nameLine}
          ${yearLine}
          <div class="alum-company">${p.Company || ''}</div>
          <div class="alum-meta">${p.Industry || ''}</div>
        </div>
      </div>`;
  }).join('');

  return `
    <div class="alum-wrap">
      <div class="alum-header">${header}</div>
      <div class="alum-list">${cards}</div>
    </div>`;
}

/* ---------- Load + interaction ---------- */
let ALUMNI_DATA = null;

map.on('load', async () => {
  const res = await fetch(GEOJSON_URL, { cache: 'no-cache' });
  if (!res.ok) {
    console.error('GeoJSON fetch failed', res.status);
    return;
  }

  const data = await res.json();
  ALUMNI_DATA = data;

  map.addSource('alumni', { type: 'geojson', data });

  map.addLayer({
    id: 'alumni-bubbles',
    type: 'circle',
    source: 'alumni',
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 2, 7, 6, 12, 10, 16],
      'circle-color': '#90846E',
      'circle-opacity': 1,
      'circle-stroke-width': 0
    }
  });

  map.on('mouseenter', 'alumni-bubbles', () => (map.getCanvas().style.cursor = 'pointer'));
  map.on('mouseleave', 'alumni-bubbles', () => (map.getCanvas().style.cursor = ''));

  map.on('click', 'alumni-bubbles', (e) => {
    if (!ALUMNI_DATA) return;
    const f = e.features && e.features[0];
    if (!f) return;

    const p = f.properties || {};
    const cityKey = (p.City || '').toLowerCase().trim();
    const ctryKey = (p.Country || '').toLowerCase().trim();

    let sameCity = ALUMNI_DATA.features.filter((x) => {
      const px = x.properties || {};
      return (
        (px.City || '').toLowerCase().trim() === cityKey &&
        (px.Country || '').toLowerCase().trim() === ctryKey
      );
    });

    if (!sameCity.length) {
      const key = JSON.stringify(f.geometry.coordinates);
      sameCity = ALUMNI_DATA.features.filter(
        (x) => JSON.stringify(x.geometry.coordinates) === key
      );
    }

    new mapboxgl.Popup({ offset: 14, maxWidth: '660px' })
      .setLngLat(f.geometry.coordinates)
      .setHTML(alumniPopupHTML(sameCity))
      .addTo(map);
  });
});
</script>
</body>
</html>

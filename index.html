<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AKPsi Alumni Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { height:100%; margin:0; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<script>
/* ===== Settings ===== */
const MAPBOX_TOKEN = 'pk.eyJ1Ijoia3RyYW4yNCIsImEiOiJjbWhkaDBodW8wMzBnMnRwcnRrZjk1dHExIn0.Mx71kV2hMNjCtuuRLB37gw';
const STYLE_URL    = 'mapbox://styles/ktran24/cmhdt73un001f01qvfzyndnek';

/* If alumni.geojson sits next to index.html, use this: */
const GEOJSON_URL  = 'alumni.geojson';
/* Or use your raw URL instead:
   const GEOJSON_URL = 'https://raw.githubusercontent.com/sophrosynable/akpsistesting/main/akpsi-alumni.geojson';
*/

mapboxgl.accessToken = MAPBOX_TOKEN;
const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [0, 20],
  zoom: 1.4,
  projection: 'globe'
});
map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');

map.on('style.load', () => {
  map.setFog({
    color: 'rgba(160,200,255,1)',
    'high-color': 'rgba(36,92,223,0.4)',
    'space-color': '#0b1434',
    'horizon-blend': 0.2,
    'star-intensity': 0.35
  });
});

/* Popup CSS so logos are not cropped */
const styleEl = document.createElement('style');
styleEl.textContent = `
  .mapboxgl-popup-content { padding: 8px 10px 10px 10px; }
  .alum-wrap { width: 300px; max-width: 90vw; }
  .alum-header {
    font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica;
    color: #041E42; margin: 4px 2px 10px;
  }
  .alum-list { max-height: 280px; overflow:auto; display:grid; gap:12px; }
  .alum-card { display:grid; grid-template-columns: 64px 1fr; gap:10px; align-items:center; }
  .alum-logo {
    width:64px; height:64px; border-radius:8px;
    object-fit:contain; background:#f5f7fb; padding:6px; border:1px solid #e6e9ef;
  }
  .alum-logo.placeholder {
    display:flex; align-items:center; justify-content:center; color:#98a1b3; font-size:10px;
  }
  .alum-name { font-weight:700; color:#0f172a; }
  .alum-company { color:#1f2937; }
  .alum-meta { color:#6b7280; font-size:12px; }
`;
document.head.appendChild(styleEl);

/* Template for the popup with many alumni */
function alumniPopupHTML(features) {
  const p0    = features[0]?.properties || {};
  const city  = p0.City || '';
  const ctry  = p0.Country || '';
  const header = [city, ctry].filter(Boolean).join(', ');

  const cards = features.map(f => {
    const p = f.properties || {};
    const img = p.PhotoURL || p.Photo || p.Logo || '';
    return `
      <div class="alum-card">
        ${img ? `<img class="alum-logo" src="${img}" alt="" loading="lazy" />`
              : `<div class="alum-logo placeholder">No image</div>`}
        <div>
          <div class="alum-name">${p.Name || ''}</div>
          <div class="alum-company">${p.Company || ''}</div>
          <div class="alum-meta">${p.Industry || ''}</div>
        </div>
      </div>`;
  }).join('');

  return `
    <div class="alum-wrap">
      <div class="alum-header">${header}</div>
      <div class="alum-list">${cards}</div>
    </div>`;
}

/* Keep data available for city-grouping */
let ALUMNI_DATA = null;

map.on('load', async () => {
  const res = await fetch(GEOJSON_URL, { cache: 'no-cache' });
  if (!res.ok) { console.error('GeoJSON fetch failed', res.status); return; }
  const data = await res.json();
  ALUMNI_DATA = data; // store globally

  // Source + bubbles
  map.addSource('alumni', { type: 'geojson', data });
  map.addLayer({
    id: 'alumni-bubbles',
    type: 'circle',
    source: 'alumni',
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 1, 3.5, 6, 7, 10, 9],
      'circle-color': '#041E42',
      'circle-opacity': 0.92,
      'circle-stroke-color': '#FFFFFF',
      'circle-stroke-width': 1
    }
  });

  map.on('mouseenter', 'alumni-bubbles', () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', 'alumni-bubbles', () => map.getCanvas().style.cursor = '');

  // CLICK => show ALL alumni with the same City + Country as the clicked feature
  map.on('click', 'alumni-bubbles', (e) => {
    if (!ALUMNI_DATA) return;

    // feature clicked
    const f = e.features && e.features[0];
    if (!f) return;

    const p = f.properties || {};
    const city     = (p.City || '').toLowerCase().trim();
    const country  = (p.Country || '').toLowerCase().trim();

    // filter all features that have the same City + Country
    let sameCity = ALUMNI_DATA.features.filter(x => {
      const px = x.properties || {};
      const c1 = (px.City || '').toLowerCase().trim();
      const c2 = (px.Country || '').toLowerCase().trim();
      return c1 === city && c2 === country;
    });

    // fallback: if City/Country missing, fall back to exact coordinates
    if (!sameCity.length) {
      const key = JSON.stringify(f.geometry.coordinates);
      sameCity = ALUMNI_DATA.features.filter(x => JSON.stringify(x.geometry.coordinates) === key);
    }

    const html = alumniPopupHTML(sameCity);
    new mapboxgl.Popup({ offset: 12, maxWidth: '360px' })
      .setLngLat(f.geometry.coordinates)
      .setHTML(html)
      .addTo(map);
  });
});
</script>
</body>
</html>
